services:
  # Logger channel
  logger.channel.search_api_postgresql:
    parent: logger.channel_base
    arguments: ['search_api_postgresql']

  # Core Services
  search_api_postgresql.connector:
    class: Drupal\search_api_postgresql\PostgreSQL\PostgreSQLConnector
    arguments:
      - '@logger.channel.search_api_postgresql'

  search_api_postgresql.field_mapper:
    class: Drupal\search_api_postgresql\PostgreSQL\FieldMapper
    arguments:
      - '@logger.channel.search_api_postgresql'

  # Embedding Services
  search_api_postgresql.embedding_service.azure_openai:
    class: Drupal\search_api_postgresql\Service\AzureOpenAIEmbeddingService
    arguments:
      - '' # endpoint - set dynamically
      - '' # api_key - set dynamically
      - '' # deployment_name - set dynamically
      - [] # config - set dynamically
      - '@http_client'
      - '@logger.channel.search_api_postgresql'

  search_api_postgresql.embedding_service.openai:
    class: Drupal\search_api_postgresql\Service\OpenAIEmbeddingService
    arguments:
      - '' # api_key - set dynamically
      - 'text-embedding-ada-002' # model
      - '@http_client'
      - '@logger.channel.search_api_postgresql'

  # Queue Management - FIXED
  search_api_postgresql.embedding_queue_manager:
    class: Drupal\search_api_postgresql\Queue\EmbeddingQueueManager
    arguments:
      - '@queue'
      - '@logger.channel.search_api_postgresql' 
      - '@config.factory'

  # Queued Embedding Service
  search_api_postgresql.queued_embedding_service:
    class: Drupal\search_api_postgresql\Service\QueuedEmbeddingService
    arguments:
      - '@search_api_postgresql.embedding_queue_manager'
      - '@logger.channel.search_api_postgresql'
      - '@config.factory'

  # Cache Management
  search_api_postgresql.cache_manager:
    class: Drupal\search_api_postgresql\Cache\EmbeddingCacheManager
    arguments:
      - '@database'
      - '@cache.default'
      - '@config.factory'
      - '@logger.channel.search_api_postgresql'

  search_api_postgresql.database_cache:
    class: Drupal\search_api_postgresql\Cache\DatabaseEmbeddingCache
    arguments:
      - '@database'
      - '@logger.channel.search_api_postgresql'
      - [] # config - set dynamically

  search_api_postgresql.memory_cache:
    class: Drupal\search_api_postgresql\Cache\MemoryEmbeddingCache
    arguments:
      - [] # config - set dynamically

  # Analytics and Monitoring
  search_api_postgresql.analytics:
    class: Drupal\search_api_postgresql\Service\EmbeddingAnalyticsService
    arguments:
      - '@database'
      - '@datetime.time'
      - '@logger.channel.search_api_postgresql'

  search_api_postgresql.cost_calculator:
    class: Drupal\search_api_postgresql\Service\CostCalculatorService
    arguments:
      - '@config.factory'

  # Configuration and Validation
  search_api_postgresql.configuration_validator:
    class: Drupal\search_api_postgresql\Service\ConfigurationValidationService
    arguments:
      - '@entity_type.manager'
      - '@key.repository'
      - '@logger.channel.search_api_postgresql'

  # Error Handling
  search_api_postgresql.error_recovery:
    class: Drupal\search_api_postgresql\Service\ErrorRecoveryService
    arguments:
      - '@logger.channel.search_api_postgresql'
      - '@state'
      - '@datetime.time'

  search_api_postgresql.error_classification:
    class: Drupal\search_api_postgresql\Service\ErrorClassificationService

  search_api_postgresql.degradation_message:
    class: Drupal\search_api_postgresql\Service\EnhancedDegradationMessageService
    arguments:
      - '@logger.channel.search_api_postgresql'

  search_api_postgresql.circuit_breaker:
    class: Drupal\search_api_postgresql\Service\CircuitBreakerService
    arguments:
      - '@state'
      - '@datetime.time'
      - '@logger.channel.search_api_postgresql'

  # Forms
  search_api_postgresql.form.embedding_management:
    class: Drupal\search_api_postgresql\Form\EmbeddingManagementForm
    arguments:
      - '@config.factory'
      - '@entity_type.manager'
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.analytics'

  search_api_postgresql.form.bulk_regenerate:
    class: Drupal\search_api_postgresql\Form\BulkRegenerateForm
    arguments:
      - '@entity_type.manager'
      - '@messenger'
      - '@search_api_postgresql.embedding_queue_manager'

  search_api_postgresql.form.cache_management:
    class: Drupal\search_api_postgresql\Form\CacheManagementForm
    arguments:
      - '@config.factory'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.analytics'

  search_api_postgresql.form.queue_management:
    class: Drupal\search_api_postgresql\Form\QueueManagementForm
    arguments:
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.analytics'
  
  # Drush Commands
  search_api_postgresql.commands:
    class: \Drupal\search_api_postgresql\Commands\SearchApiPostgreSQLCommands
    arguments:
      - '@entity_type.manager'
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.configuration_validator'
      - '@logger.channel.search_api_postgresql'
    tags:
      - { name: drush.command }

  # Admin Controller
  search_api_postgresql.admin_controller:
    class: Drupal\search_api_postgresql\Controller\EmbeddingAdminController
    arguments:
      - '@entity_type.manager'
      - '@search_api_postgresql.analytics'
      - '@search_api_postgresql.configuration_validator'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.embedding_queue_manager'

parameters:
  search_api_postgresql.default_batch_size: 50
  search_api_postgresql.max_retries: 3
  search_api_postgresql.cache_ttl: 604800 # 7 days
  search_api_postgresql.queue_lease_time: 3600 # 1 hour