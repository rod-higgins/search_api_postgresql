services:
  # Core Services
  logger.channel.search_api_postgresql:
    parent: logger.channel_base
    arguments: ['search_api_postgresql']

  # PostgreSQL Connector Factory
  search_api_postgresql.connector_factory:
    class: Drupal\search_api_postgresql\PostgreSQL\PostgreSQLConnectorFactory
    arguments:
      - '@logger.channel.search_api_postgresql'

  # Field Mapper Service
  search_api_postgresql.field_mapper:
    class: Drupal\search_api_postgresql\PostgreSQL\FieldMapper
    arguments:
      - '@logger.channel.search_api_postgresql'

  # Embedding Services
  search_api_postgresql.embedding_service.azure:
    class: Drupal\search_api_postgresql\Service\AzureOpenAIEmbeddingService
    arguments:
      - '@config.factory'
      - '@key.repository'
      - '@logger.channel.search_api_postgresql'
      - '@http_client'
    tags:
      - { name: search_api_postgresql_embedding_service, id: azure_openai }

  search_api_postgresql.embedding_service.openai:
    class: Drupal\search_api_postgresql\Service\OpenAIEmbeddingService
    arguments:
      - '@config.factory'
      - '@key.repository'
      - '@logger.channel.search_api_postgresql'
      - '@http_client'
    tags:
      - { name: search_api_postgresql_embedding_service, id: openai }

  # Embedding Cache Services
  search_api_postgresql.embedding_cache:
    class: Drupal\search_api_postgresql\Cache\DatabaseEmbeddingCache
    arguments:
      - '@database'
      - '@logger.channel.search_api_postgresql'
      - '@config.factory'

  search_api_postgresql.cache_manager:
    class: Drupal\search_api_postgresql\Cache\EmbeddingCacheManager
    arguments:
      - '@search_api_postgresql.embedding_cache'
      - '@logger.channel.search_api_postgresql'

  # Queue Management
  search_api_postgresql.embedding_queue_manager:
    class: Drupal\search_api_postgresql\Queue\EmbeddingQueueManager
    arguments:
      - '@queue'
      - '@state'
      - '@logger.channel.search_api_postgresql'
      - '@config.factory'

  # Circuit Breaker Service
  search_api_postgresql.circuit_breaker:
    class: Drupal\search_api_postgresql\CircuitBreaker\CircuitBreaker
    arguments:
      - 'search_api_postgresql'
      - '@state'
      - '@cache.default'
      - '@logger.channel.search_api_postgresql'

  # Analytics and Monitoring
  search_api_postgresql.analytics:
    class: Drupal\search_api_postgresql\Service\EmbeddingAnalyticsService
    arguments:
      - '@database'
      - '@state'
      - '@datetime.time'
      - '@logger.channel.search_api_postgresql'

  # Configuration Validation
  search_api_postgresql.configuration_validator:
    class: Drupal\search_api_postgresql\Service\ConfigurationValidationService
    arguments:
      - '@entity_type.manager'
      - '@key.repository'
      - '@logger.channel.search_api_postgresql'

  # Form Services
  search_api_postgresql.form.embedding_management:
    class: Drupal\search_api_postgresql\Form\EmbeddingManagementForm
    arguments:
      - '@entity_type.manager'
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.analytics'

  search_api_postgresql.form.bulk_regenerate:
    class: Drupal\search_api_postgresql\Form\BulkRegenerateForm
    arguments:
      - '@entity_type.manager'
      - '@messenger'
      - '@search_api_postgresql.embedding_queue_manager'

  search_api_postgresql.form.cache_management:
    class: Drupal\search_api_postgresql\Form\CacheManagementForm
    arguments:
      - '@config.factory'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.analytics'

  search_api_postgresql.form.queue_management:
    class: Drupal\search_api_postgresql\Form\QueueManagementForm
    arguments:
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.analytics'

  # Admin Controller
  search_api_postgresql.admin_controller:
    class: Drupal\search_api_postgresql\Controller\EmbeddingAdminController
    arguments:
      - '@entity_type.manager'
      - '@search_api_postgresql.analytics'
      - '@search_api_postgresql.configuration_validator'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.embedding_queue_manager'

  # Drush Commands
  search_api_postgresql.commands:
    class: Drupal\search_api_postgresql\Commands\SearchApiPostgreSQLCommands
    arguments:
      - '@entity_type.manager'
      - '@search_api_postgresql.embedding_queue_manager'
      - '@search_api_postgresql.cache_manager'
      - '@search_api_postgresql.configuration_validator'
      - '@logger.channel.search_api_postgresql'
    tags:
      - { name: drush.command }

parameters:
  search_api_postgresql.default_batch_size: 50
  search_api_postgresql.max_retries: 3
  search_api_postgresql.cache_ttl: 604800 # 7 days
  search_api_postgresql.queue_lease_time: 3600 # 1 hour